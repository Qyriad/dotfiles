#!/usr/bin/env xonsh
# vim: ft=xonsh

$RAISE_SUBPROC_ERROR = True
$XONSH_SUBPROC_OUTPUT_FORMAT = 'stream_lines'
$XONSH_SHOW_TRACEBACK = True

import argparse
import enum
from enum import StrEnum
import functools
from pathlib import Path
from typing import Optional

_uses_xdg = None
def uses_xdg() -> bool:
	global _uses_xdg
	if _uses_xdg is None:
		_uses_xdg = 'true' in $(nix config show | rg use-xdg-base-directories)
	return _uses_xdg

_xdg_state = None
def xdg_state() -> Path:
	global _xdg_state
	if _xdg_state is None:
		try:
			_xdg_state = Path($XDG_STATE_DIR)
		except KeyError:
			_xdg_state = p'~/.local/state'.expanduser()
	return _xdg_state

def generation_spec(arg: int | str) -> int | str:
	if arg != "all":
		return int(arg)
	return arg

class ProfileKind(StrEnum):
	system = enum.auto()
	user = enum.auto()

	def _base(self) -> str:
		match self:
			case 'system':
				return '/nix/var/nix/profiles/'
			case 'user':
				if uses_xdg():
					return f'{xdg_state().as_posix()}/nix/profiles/'
				else:
					return p'~/.nix'.expanduser().as_posix()

	def _stem(self) -> str:
		match self:
			case 'system':
				return 'system'
			case 'user':
				return 'profile'

	def _gens(self, base: str, stem: str) -> list[str]:
		return $(fd -t l @(f'^{stem}-') @(base) | sort --numeric-sort).splitlines()

	def get(self, gen: Optional[int]) -> str:
		base = self._base()
		stem = self._stem()
		if gen is None:
			return f'{base}{stem}'

		gen_path = self._gens(base, stem)[gen]
		return gen_path

	def list(self) -> list[str]:
		base = self._base()
		stem = self._stem()

		return self._gens(base, stem)

parser = argparse.ArgumentParser()
parser.add_argument('profile_kind', default='system', nargs='?', type=ProfileKind, choices=ProfileKind)
parser.add_argument('-u', '--user', type=str, help="Override user to use for 'user' type profile")
parser.add_argument('-g', '--generation', required=False, type=generation_spec, metavar="GEN",
	help='if negative, indexes from the most recent. -1 is the most recent, -2 is the next most recent',
)
parser.add_argument('-a', '--all', action='store_true',
	help='equivalent to --generation=all',
)
parser.add_argument('-c', '--current', action='store_true',
	help='equivalent to --generation=-1',
)

args = parser.parse_args()
if args.all:
	args.generation = "all"
if args.current:
	args.generation = -1

if args.generation == "all":
	print("\n".join(args.profile_kind.list()))
else:
	print(args.profile_kind.get(args.generation))
