#!/usr/bin/env python3

import shutil
import shlex
import os
from pathlib import Path
import sys

NIXOS_OPT_LLVM = Path('/run/current-system/sw/opt/llvm/bin/cc')

CC = None
if cc_from_env := os.getenv("CC"):
    CC = shutil.which(cc_from_env)

if not CC:
    if NIXOS_OPT_LLVM.exists(follow_symlinks=True):
        CC = NIXOS_OPT_LLVM.as_posix()

if not CC:
    raise ValueError("cannot find C compiler; set $CC to override")

libraries = sys.argv[1:]
if not libraries:
    raise ValueError("usage: find-lib <FOOLIB>")

args = [
    CC,
    "-Wl,-t",
    "-o", "/dev/null",
    "/dev/null",
    "-shared",
    "-nostdlib",
    *[f'-l{lib}' for lib in libraries],
    *shlex.split(os.getenv("CFLAGS", "")),
]

os.execv(CC, args)
